---
kind: pipeline
name: matrix-1
type: kubernetes

steps:
- name: build_app
  pull: if-not-exists
  image: docker
  commands:
  - docker build -t icasework-resolver .
  when:
    branch: [ master, features/* ]
    event: [ pull_request, push ]

- name: docker-build-and-push
  pull: if-not-exists
  image: ukhomeoffice/drone-docker
  environment:
    DOCKER_PASSWORD:
      from_secret: DOCKER_PASSWORD
    commands:
      - docker login -u="ukhomeofficedigital+icasework_resolver" -p=$${DOCKER_PASSWORD} quay.io
      - docker tag icasework-resolver quay.io/ukhomeofficedigital/modern-slavery-data-service:2.0.0-${DRONE_BUILD_NUMBER}-${DRONE_COMMIT:0:10}
      - docker tag icasework-resolver quay.io/ukhomeofficedigital/modern-slavery-data-service:2.0.0
      - docker tag icasework-resolver quay.io/ukhomeofficedigital/modern-slavery-data-service:2.0
      - docker tag icasework-resolver quay.io/ukhomeofficedigital/modern-slavery-data-service:2
      - docker tag icasework-resolver quay.io/ukhomeofficedigital/modern-slavery-data-service:latest
      - docker push quay.io/ukhomeofficedigital/modern-slavery-data-service:2.0.0-${DRONE_BUILD_NUMBER}-${DRONE_COMMIT:0:10}
      - docker push quay.io/ukhomeofficedigital/modern-slavery-data-service:2.0.0
      - docker push quay.io/ukhomeofficedigital/modern-slavery-data-service:2.0
      - docker push quay.io/ukhomeofficedigital/modern-slavery-data-service:2
      - docker push quay.io/ukhomeofficedigital/modern-slavery-data-service:latest
    when:
      branch: master
      event: push

...
